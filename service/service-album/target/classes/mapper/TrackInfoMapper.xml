<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<mapper namespace="com.atguigu.tingshu.album.mapper.TrackInfoMapper">


    <select id="getUserTrackPage" resultType="com.atguigu.tingshu.vo.album.TrackListVo">
        select
            ti.id as track_id,
            ti.album_id,
            ti.track_title,
            ti.cover_url,
            ti.media_duration,
            ti.`status`,
            max(if(ts.stat_type ='0701', ts.stat_num, 0)) as play_stat_num,
            max(if(ts.stat_type ='0702', ts.stat_num, 0)) as collect_stat_num,
            max(if(ts.stat_type ='0703', ts.stat_num, 0)) as praise_stat_num,
            max(if(ts.stat_type ='0704', ts.stat_num, 0)) as comment_stat_num
        from
            track_info ti inner join track_stat ts on ti.id = ts.track_id and ts.is_deleted = 0

        <trim prefix="where" prefixOverrides="and|or">
            <if test="vo.userId != null">
                and ti.user_id = #{vo.userId}
            </if>
            <if test="vo.status != null and vo.status != ''">
                and  ti.status = #{vo.status}
            </if>
            <if test="vo.trackTitle != null and vo.trackTitle != ''">
                and  ti.track_title like concat('%',#{vo.trackTitle},'%')
            </if>
            and ti.is_deleted = 0
        </trim>
        GROUP BY ti.id
        ORDER BY ti.id DESC
    </select>
    <select id="findAlbumTrackPage" resultType="com.atguigu.tingshu.vo.album.AlbumTrackListVo">
        select
            ti.id as track_id,
            ti.track_title,
            ti.media_duration,
            ti.create_time,
            ti.order_num,
            max(if(ts.stat_type = '0701', ts.stat_num, 0)) as play_stat_num,
            max(if(ts.stat_type = '0702', ts.stat_num, 0)) as collect_stat_num,
            max(if(ts.stat_type = '0703', ts.stat_num, 0)) as praise_stat_num,
            max(if(ts.stat_type = '0704', ts.stat_num, 0)) as comment_stat_num
        from
            track_info ti inner join track_stat ts on ti.id = ts.track_id and ts.is_deleted = 0
        where ti.album_id = #{albumId} and ti.status = "0501" and ti.is_deleted = 0
        group by ti.id
        order by ti.order_num
    </select>


    <select id="getTrackStatVo" resultType="com.atguigu.tingshu.vo.album.TrackStatVo">
        SELECT
            max(IF(stat_type='0701',stat_num,0)) as play_stat_num,
            max(IF(stat_type='0702',stat_num,0)) as collect_stat_num,
            max(IF(stat_type='0703',stat_num,0)) as praise_stat_num,
            max(IF(stat_type='0704',stat_num,0)) as comment_stat_num
        from
            track_stat ts
        where track_id = #{trackId} and is_deleted = 0
    </select>
</mapper>

